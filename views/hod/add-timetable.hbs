<section>
    <div class="container py-5 border bg-light rounded-lg shadow-sm">
        <h2 class="text-center mb-4 text-primary">Create Timetable</h2>

        <!-- Display Flash Success Message -->
        {{#if day}}
        <div class="alert alert-success mb-4 {{year}}">
            <strong>{{year}} {{day}}</strong> timetable created successfully!
        </div>
        {{/if}}

        <!-- Timetable Creation Form -->
        <div class="row justify-content-center">
            <div class="col-md-10 col-lg-8">
                <form action="/hod/add-timetable" method="POST">
                    <!-- Course Selection -->
                    <div class="mb-4">
                        <label for="course" class="form-label fw-bold text-secondary">Course</label>
                        <select id="course" name="course" class="form-select border-secondary bg-light" required>
                            <option value="">Choose a course</option>
                            {{#each courses}}
                            <option value="{{this}}">{{this}}</option>
                            {{/each}}
                        </select>
                    </div>

                    <!-- Semester Selection -->
                    <div class="mb-4">
                        <label class="form-label fs-5 text-dark">Select Semester</label>
                        <select class="form-select custom-select" name="semester" required>
                            <option value="">Choose Semester</option>
                            {{#each classTeachers}}
                            <option value="{{this}}">{{this}}</option>
                            {{/each}}
                        </select>
                    </div>

                    <!-- Day Selection -->
                    <div class="mb-4">
                        <label for="daySelect" class="form-label fs-5 text-dark">Day</label>
                        <select id="daySelect" class="form-select custom-select" name="day" required>
                            <option value="">Choose a day...</option>
                            <option value="monday">Monday</option>
                            <option value="tuesday">Tuesday</option>
                            <option value="wednesday">Wednesday</option>
                            <option value="thursday">Thursday</option>
                            <option value="friday">Friday</option>
                        </select>
                    </div>

                    <!-- Time Slot Section -->
                    <div id="timeSlotSection">
                        <div class="time-slot mb-4 border p-4 rounded shadow-sm">
                            <h5 class="text-secondary mb-3">Time Slot 1</h5>

                            <!-- Time Slot Input -->
                            <div class="mb-3">
                                <label for="timeSlot1" class="form-label">Time Slot</label>
                                <input type="text" id="timeSlot1" class="form-control custom-input" name="timeslots"
                                    placeholder="e.g., 9:30 AM - 10:00 AM" required>
                            </div>

                            <!-- Teacher Selection -->
                            <div class="mb-3">
                                <label class="form-label fs-5">Teacher</label>
                                <select id="teacherDropdown" class="form-select custom-select" name="teachers" required>
                                    <option value="">Choose a teacher...</option>
                                    {{#each teachersInfo}}
                                    <option value="{{this.name}}" data-subjects="{{this.subjects}}">{{this.name}}</option>
                                    {{/each}}
                                </select>
                            </div>

                            <!-- Subject Dropdown -->
                            <div class="mb-3">
                                <label for="subject" class="form-label fs-5">Subject</label>
                                <select id="subjectDropdown" class="form-select custom-select" name="subjects" required>
                                    <option value="">Choose a subject...</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Add/Remove Time Slot Buttons -->
                    <div class="text-center mb-4">
                        <button type="button" class="btn btn-outline-success me-3" id="addTimeSlot">
                            <i class="fas fa-plus-circle"></i> Add More Time Slots
                        </button>
                        <button type="button" class="btn btn-outline-danger" id="removeTimeSlot">
                            <i class="fas fa-minus-circle"></i> Remove Last Slot
                        </button>
                    </div>

                    <!-- Submit Button -->
                    <div class="text-center">
                        <button type="submit" class="btn btn-primary btn-lg">Submit Timetable</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</section>

<script>
    // Get references to the existing dropdowns
    const teacherDropdown = document.getElementById('teacherDropdown');
    const subjectDropdown = document.getElementById('subjectDropdown');

    // Listen for changes on the teacher dropdown for the first time slot
    if (teacherDropdown) {
        teacherDropdown.addEventListener('change', function () {
            updateSubjectDropdown(subjectDropdown, teacherDropdown);
        });
    }

    // Function to update the subject dropdown based on selected teacher
    function updateSubjectDropdown(subjectDropdown, teacherDropdown) {
        // Clear the subject dropdown
        subjectDropdown.innerHTML = '<option value="">Choose a subject...</option>';

        // Get the selected teacher's subjects
        const selectedTeacher = teacherDropdown.options[teacherDropdown.selectedIndex];
        const subjects = selectedTeacher.getAttribute('data-subjects');

        if (subjects) {
            // Split the subjects and populate the dropdown
            const subjectsArray = subjects.split(','); // Assumes subjects are comma-separated
            subjectsArray.forEach((subject) => {
                const option = document.createElement('option');
                option.value = subject.trim();
                option.textContent = subject.trim();
                subjectDropdown.appendChild(option);
            });
        }
    }

    // Add Time Slot
    document.getElementById("addTimeSlot").addEventListener("click", function () {
        const timeSlotSection = document.getElementById("timeSlotSection");
        const timeSlotCount = timeSlotSection.getElementsByClassName("time-slot").length + 1;

        const newTimeSlot = document.createElement("div");
        newTimeSlot.className = "time-slot mb-4 border p-4 rounded shadow-sm";
        newTimeSlot.innerHTML = `
            <h5 class="text-secondary mb-3">Time Slot ${timeSlotCount}</h5>
            <div class="mb-3">
                <label for="timeSlot${timeSlotCount}" class="form-label">Time Slot</label>
                <input type="text" id="timeSlot${timeSlotCount}" class="form-control custom-input" name="timeslots" placeholder="e.g., 9:30 AM - 10:00 AM" required>
            </div>
            <div class="mb-3">
                <label class="form-label fs-5">Teacher</label>
                <select class="teacher-dropdown form-select custom-select" name="teachers" required>
                    <option value="">Choose a teacher...</option>
                    {{#each teachersInfo}}
                    <option value="{{this.name}}" data-subjects="{{this.subjects}}">{{this.name}}</option>
                    {{/each}}
                </select>
            </div>
            <div class="mb-3">
                <label for="subject" class="form-label fs-5">Subject</label>
                <select class="subject-dropdown form-select custom-select" name="subjects" required>
                    <option value="">Choose a subject...</option>
                </select>
            </div>
        `;
        timeSlotSection.appendChild(newTimeSlot);

        // Get the newly added dropdowns
        const newTeacherDropdown = newTimeSlot.querySelector(".teacher-dropdown");
        const newSubjectDropdown = newTimeSlot.querySelector(".subject-dropdown");

        // Add event listener for teacher dropdown in the new time slot
        newTeacherDropdown.addEventListener("change", function () {
            updateSubjectDropdown(newSubjectDropdown, newTeacherDropdown);
        });
    });

    // Remove Time Slot
    document.getElementById("removeTimeSlot").addEventListener("click", function () {
        const timeSlotSection = document.getElementById("timeSlotSection");
        const timeSlots = timeSlotSection.getElementsByClassName("time-slot");
        if (timeSlots.length > 1) {
            timeSlotSection.removeChild(timeSlots[timeSlots.length - 1]);
        } else {
            alert("You must have at least one time slot.");
        }
    });
</script>

<style>
    .custom-select,
    .custom-input {
        max-width: 100%;
    }

    .time-slot {
        background-color: #f9f9f9;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        border-radius: 8px;
        padding: 1.5rem;
    }

    .time-slot h5 {
        color: #333;
    }

    .btn-outline-success {
        color: #28a745;
        border-color: #28a745;
    }

    .btn-outline-danger {
        color: #dc3545;
        border-color: #dc3545;
    }

    .btn-outline-success:hover,
    .btn-outline-danger:hover {
        background-color: #f1f1f1;
    }

    .btn-primary {
        background-color: #007bff;
        border-color: #007bff;
    }

    .btn-primary:hover {
        background-color: #0056b3;
        border-color: #0056b3;
    }

    .form-label {
        font-weight: 500;
    }

    .form-select {
        font-size: 1rem;
    }

    .alert {
        font-size: 1.1rem;
        padding: 1rem;
    }
</style>
